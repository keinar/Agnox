<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agnox — System Status</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          animation: {
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }
        }
      }
    };
  </script>
</head>

<body class="bg-gray-950 text-gray-100 min-h-screen font-sans antialiased">

  <!-- ── Config ── -->
  <!-- Replace these values before serving the page. -->
  <script>
    // In production, inject these via your CI/CD pipeline or a server-side template.
    // Never commit real secret values to source control.
    const CONFIG = {
      apiBase: 'https://api.agnox.dev',
      monitorSecret: 'MONITORING_SECRET_KEY',
      refreshIntervalMs: 30_000,
    };
  </script>

  <!-- ── Header ── -->
  <header class="border-b border-gray-800 bg-gray-900/60 backdrop-blur sticky top-0 z-10">
    <div class="max-w-5xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <!-- Logo mark -->
        <div
          class="w-8 h-8 rounded-lg bg-violet-600 flex items-center justify-center font-bold text-white text-sm select-none">
          A</div>
        <span class="text-lg font-semibold tracking-tight">Agnox Ops Dashboard</span>
        <span class="text-xs text-gray-500 bg-gray-800 px-2 py-0.5 rounded-full">v3.5.0</span>
      </div>
      <div class="flex items-center gap-3">
        <span id="last-updated" class="text-xs text-gray-500">Never refreshed</span>
        <button id="fetch-btn" onclick="fetchStatus()"
          class="inline-flex items-center gap-1.5 text-sm font-medium px-4 py-1.5 rounded-lg bg-violet-600 hover:bg-violet-500 active:bg-violet-700 transition-colors focus:outline-none focus:ring-2 focus:ring-violet-500 focus:ring-offset-2 focus:ring-offset-gray-900">
          <svg id="btn-icon" xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Fetch Now
        </button>
      </div>
    </div>
  </header>

  <!-- ── Main ── -->
  <main class="max-w-5xl mx-auto px-6 py-10 space-y-8">

    <!-- Overall Health Banner -->
    <section>
      <div id="health-banner"
        class="rounded-2xl border p-6 flex items-center gap-5 transition-all duration-300 bg-gray-800/50 border-gray-700">
        <div id="health-dot" class="w-5 h-5 rounded-full bg-gray-600 flex-shrink-0"></div>
        <div>
          <p class="text-xs uppercase tracking-widest text-gray-500 mb-0.5">System Health</p>
          <p id="health-label" class="text-2xl font-bold text-gray-400">—</p>
        </div>
        <div class="ml-auto text-right">
          <p class="text-xs text-gray-500">Auto-refreshes every 30 s</p>
          <div class="flex items-center justify-end gap-1.5 mt-1">
            <span class="inline-block w-1.5 h-1.5 rounded-full bg-violet-400 animate-pulse-slow"></span>
            <span class="text-xs text-gray-400">Live</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Metric Cards -->
    <section class="grid grid-cols-1 sm:grid-cols-3 gap-4">

      <!-- Pending Tasks -->
      <div class="rounded-xl border border-gray-800 bg-gray-900 p-5 space-y-3">
        <div class="flex items-center justify-between">
          <p class="text-xs font-medium uppercase tracking-wider text-gray-500">Pending Tasks</p>
          <!-- Queue icon -->
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-amber-400" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="1.8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
          </svg>
        </div>
        <p id="queue-depth" class="text-4xl font-bold tabular-nums text-white">—</p>
        <p class="text-xs text-gray-600">Messages in <code class="text-gray-500">test_queue</code></p>
      </div>

      <!-- Active Workers -->
      <div class="rounded-xl border border-gray-800 bg-gray-900 p-5 space-y-3">
        <div class="flex items-center justify-between">
          <p class="text-xs font-medium uppercase tracking-wider text-gray-500">Active Workers</p>
          <!-- CPU icon -->
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-sky-400" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="1.8">
            <rect x="4" y="4" width="16" height="16" rx="2" stroke-linecap="round" stroke-linejoin="round" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 9h6v6H9z" />
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M9 2v2M15 2v2M9 20v2M15 20v2M2 9h2M2 15h2M20 9h2M20 15h2" />
          </svg>
        </div>
        <p id="active-workers" class="text-4xl font-bold tabular-nums text-white">—</p>
        <p class="text-xs text-gray-600">RabbitMQ consumers connected</p>
      </div>

      <!-- DB Status -->
      <div class="rounded-xl border border-gray-800 bg-gray-900 p-5 space-y-3">
        <div class="flex items-center justify-between">
          <p class="text-xs font-medium uppercase tracking-wider text-gray-500">Database</p>
          <!-- DB icon -->
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-emerald-400" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="1.8">
            <ellipse cx="12" cy="5" rx="9" ry="3" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 5v14c0 1.657 4.03 3 9 3s9-1.343 9-3V5" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 12c0 1.657 4.03 3 9 3s9-1.343 9-3" />
          </svg>
        </div>
        <p id="db-status" class="text-4xl font-bold text-gray-500">—</p>
        <p class="text-xs text-gray-600">MongoDB ping</p>
      </div>

    </section>

    <!-- Error Banner (hidden by default) -->
    <div id="error-banner" class="hidden rounded-xl border border-red-900/60 bg-red-950/40 p-4 flex items-start gap-3">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-red-400 flex-shrink-0 mt-0.5" fill="none"
        viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round"
          d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
      </svg>
      <div>
        <p class="text-sm font-semibold text-red-300">Fetch failed</p>
        <p id="error-message" class="text-xs text-red-400 mt-0.5"></p>
      </div>
    </div>

    <!-- Footer / Timestamp -->
    <footer class="text-center text-xs text-gray-700 pt-4">
      <p>Agnox Internal Ops Dashboard &mdash; not for public distribution</p>
    </footer>

  </main>

  <!-- ── Logic ── -->
  <script>
    let autoRefreshTimer = null;

    async function fetchStatus() {
      const btn = document.getElementById('fetch-btn');
      const icon = document.getElementById('btn-icon');

      // Loading state
      btn.disabled = true;
      icon.classList.add('animate-spin');

      try {
        const res = await fetch(`${CONFIG.apiBase}/api/system/monitor-status`, {
          method: 'GET',
          headers: { 'X-Agnox-Monitor-Secret': CONFIG.monitorSecret },
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status} — ${res.statusText}`);
        }

        const json = await res.json();

        if (json.status !== 'ok') {
          throw new Error('API returned non-ok status');
        }

        applyData(json);
        hideError();

        document.getElementById('last-updated').textContent =
          'Updated ' + new Date().toLocaleTimeString();

      } catch (err) {
        showError(err.message || 'Unknown error');
        setHealthState('degraded');
      } finally {
        btn.disabled = false;
        icon.classList.remove('animate-spin');
      }
    }

    function applyData(json) {
      const { queueDepth, activeWorkers, dbConnected } = json.data;

      document.getElementById('queue-depth').textContent = queueDepth ?? '—';
      document.getElementById('active-workers').textContent = activeWorkers ?? '—';

      const dbEl = document.getElementById('db-status');
      if (dbConnected) {
        dbEl.textContent = 'OK';
        dbEl.className = 'text-4xl font-bold text-emerald-400';
      } else {
        dbEl.textContent = 'DOWN';
        dbEl.className = 'text-4xl font-bold text-red-400';
      }

      const isHealthy = dbConnected;
      setHealthState(isHealthy ? 'ok' : 'degraded');
    }

    function setHealthState(state) {
      const banner = document.getElementById('health-banner');
      const dot = document.getElementById('health-dot');
      const label = document.getElementById('health-label');

      if (state === 'ok') {
        banner.className = 'rounded-2xl border p-6 flex items-center gap-5 transition-all duration-300 bg-emerald-950/30 border-emerald-800/50';
        dot.className = 'w-5 h-5 rounded-full bg-emerald-400 flex-shrink-0 animate-pulse';
        label.className = 'text-2xl font-bold text-emerald-300';
        label.textContent = 'All Systems Operational';
      } else {
        banner.className = 'rounded-2xl border p-6 flex items-center gap-5 transition-all duration-300 bg-red-950/30 border-red-800/50';
        dot.className = 'w-5 h-5 rounded-full bg-red-400 flex-shrink-0 animate-pulse';
        label.className = 'text-2xl font-bold text-red-300';
        label.textContent = 'Degraded';
      }
    }

    function showError(msg) {
      document.getElementById('error-banner').classList.remove('hidden');
      document.getElementById('error-message').textContent = msg;
    }

    function hideError() {
      document.getElementById('error-banner').classList.add('hidden');
    }

    function scheduleAutoRefresh() {
      clearInterval(autoRefreshTimer);
      autoRefreshTimer = setInterval(fetchStatus, CONFIG.refreshIntervalMs);
    }

    // Boot
    fetchStatus();
    scheduleAutoRefresh();
  </script>

</body>

</html>